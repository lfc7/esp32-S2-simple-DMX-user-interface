<!DOCTYPE html>
<html>
<head>
<title>DMXui - VU DMX</title>
<meta name="viewport" content="width=device-width, initial-scale=0.80, maximum-scale=0.80">
<meta charset="utf-8">
<meta http-equiv="Cache-control" content="public">
<link rel="icon" href="data:,">

<style>

h1 { font-weight: bold; font-size: width/2pt;}
h2 { font-weight: bold; font-size: width/2pt;}
button { font-weight: bold; font-size: width/2pt;}

/* Add some basic styling for the chat window */
body {
	background-color:#483C32;
	font-size: 11px;
	font-family: sans-serif;
}

label {
	margin-left: -300px;
	width: 50px;
	height: 25px;
	text-align: center;
	position: absolute;
	margin-top: 10px;
}
.chat-container {
  width: 400px;
  margin: 0 auto;
  /*  padding: 10px;*/
}
.chat-messages {
  height: 250px;
  overflow-y: auto;
  border: 1px solid #444;
  padding: 5px;
  margin-bottom: 5px;
}
.user-input {
  display: flex;
  margin-bottom: 20px;
}
.user-input input {
  flex: 1;
  border: 1px solid #444;
  padding: 5px;
}
.user-input button {
  margin-left: 5px;
  background-color: #007bff;
  color: #fff;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
}
.websocket {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}
.websocket button {
  background-color: #007bff;
  color: #fff;
  border: none;
  padding: 5px 10px;
  cursor: pointer;
}
.websocket .label {
  margin-left: auto;
}

.hide_ws {
  display: none;
}

.ui-state-error {
	border: 1px solid #f1a899;
	background: #e4b2b2;
	color: #323232;
}
a.dmxlink {
	text-decoration: none; 
	font-family: sans-serif;
	display: inline-block;
	width: 30px;
    height: 20px;
    line-height: 20px;
	margin-right: 20px;
	color: #fff;
	border: 2px solid #aaa;
	background: #555;
	border-radius: 3px;
}
.links {
  width: 400px;
  margin: 0 auto;
  text-align: center; 
  
}
table {  
border-collapse: collapse;  
width: 100%;  
font-size: 11px;
}

th, td {  
border: 1px solid #868686;  
text-align: left;  
}
.dmx_ch {    
color: white;  
margin: 1px;
}  
.dmx_val {  
background-color: #000;  
color: white;  
}  
.nav_cont
{ 
	margin: auto;
	width: 400px;
	/*padding: 10px;*/
	  display: flex;
	flex-wrap: wrap;
  /*justify-content: space-evenly;*/
	}
.nav
{ 
	margin: auto;
	/* width: 400px; */
	/*padding: 10px;*/
	flex-basis: auto;
	}
	
.class_nav_butt {
		height: 25px;  
		width: 25px;
		margin: auto;
	}

.class_nav_input {
		height: 25px;  
		width: 25px;
		text-align: center;
		margin: auto;
	}

.dim {
	width: 400px;
	flex-basis: auto;
	margin: auto;
	text-align: center;
	background-color:#aaa;
	color:#000;
	border-radius: 5px;
}

.fct { 
	/*flex-basis: 50%% ;*/
	margin: auto;
	/*text-align: right;*/
	display: grid;
}

.class_fct_butt {
		height: 25px;  
		width: 35px;
		text-align: center;
		margin:0.5em auto;
}
	
.container { 
	margin:1em auto;
	border-collapse:collapse
	width: 400px;
	/*padding: 10px;*/
	}
	
.class_full_butt {
		height: 25px;  
		width: 30px;
		margin: auto;
		margin-right: 5px;
	}

.class_flash_butt {
		height: 25px;  
		width: 30px;
		margin: auto;
		margin-right: 5px;
	}
	
.class_mute_butt {
		height: 25px;  
		width: 30px;
		margin: auto;
		margin-right: 5px;
	}
	
.class_butt_selected {
	border: 3px solid #d51616;
	/* background: #a24949; */
	/* color: #323232; */
}
	
.class_fx_butt {
		height: 25px;  
		width: 30px;
		margin: auto;
		margin-left: 5px;
	}
	
#spacer_20 {
	height: 20px;
}
	
.slideval {
	height: 30px;
	margin: 5px;
	font-family: sans-serif;
	font-size: 13px;
	font-weight: bold;
	color: black;
	position: absolute;
	pointer-events: none;
	
}

.masterval {
	height: 30px;
	margin: 5px;
	font-family: sans-serif;
	font-size: 13px;
	font-weight: bold;
	color: black;
	position: absolute;
	pointer-events: none;
	
}

.unselectable {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}


.class_fader_name {
		height: 25px;  
		width: 50px;
		text-align: center;
		/*margin: 1px;*/
		margin: auto;
	}

.settingscontainer {
	width: 400px;
	margin: 0 auto;
	
	/* padding: 10px; */
	margin-top: 10px;
}

.settingscontainer_hide {
	display: none;
}

.slidecontainer {
	width: 400px;
	margin: 0 auto;
	/* padding: 10px; */
	margin-top: 10px;
}



/* The slider itself */

.slider {
	-webkit-appearance: none;
	appearance: none;
	width: 80%%;
	height: 25px;
	background: #d3d3d3;
	outline: none;
	opacity: 0.4;
	-webkit-transition: .2s;
	transition: opacity .2s;
	border-radius: 2px;
	vertical-align: middle;
}

.sliderM {
	-webkit-appearance: none;
	appearance: none;
	width: 50%%;
	height: 25px;
	background: #d3d3d3;
	outline: none;
	opacity: 0.7;
	-webkit-transition: .2s;
	transition: opacity .2s;
	border-radius: 2px;
	vertical-align: middle;
}

/* Mouse-over effects */
.slider:hover {
  opacity: 1; /* Fully shown on mouse-over */
}

.sliderM:hover{
  opacity: 1; /* Fully shown on mouse-over */
}

/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
.slider::-webkit-slider-thumb {
  -webkit-appearance: none; /* Override default look */
  appearance: none;
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  border-radius: 2px; 
  background: #04AA6D; /* Green background */
  cursor: pointer; /* Cursor on hover */
}

.sliderM::-webkit-slider-thumb{
  -webkit-appearance: none; /* Override default look */
  appearance: none;
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  border-radius: 2px; 
  background: #04AA6D; /* Green background */
  cursor: pointer; /* Cursor on hover */
}

.slider::-moz-range-thumb{
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  background: #04AA6D; /* Green background */
  cursor: pointer; /* Cursor on hover */
}
.sliderM::-moz-range-thumb{
  width: 25px; /* Set a specific slider handle width */
  height: 25px; /* Slider handle height */
  background: #04AA6D; /* Green background */
  cursor: pointer; /* Cursor on hover */
}

output {
	/* position: absolute; */
	/* background-image: linear-gradient(#444444, #999999); */
	width: 40px;
	/* height: 30px; */
	text-align: right;
	color: white;
	border-radius: 5px;
	display: inline-block;
	font: bold 12px/26px sans-serif;
	/* bottom: 175 %%; */
	/* left: 0; */
}

.outputM {
	/* position: absolute; */
	/* background-image: linear-gradient(#444444, #999999); */
	width: 30px;
	/* height: 30px; */
	text-align: right;
	color: white;
	border-radius: 5px;
	display: inline-block;
	font: bold 12px/26px sans-serif;
	/* bottom: 175 %%; */
	/* left: 0; */
}

.class_set_butt {
	position: absolute;
	/* background-image: linear-gradient(#444444, #999999); */
	text-align: right;
	color: white;
	border-radius: 5px;
	/* display: inline-block; */
	/* bottom: 175 %%; */
	/* left: 0; */
}


/*
output:after { 
  content: "";
  position: absolute; 
  width: 0;
  height: 0;
  border-top: 10px solid #999999;
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  top: 100%%;
  left: 50%%;
  margin-left: -5px;
  margin-top: -1px;
}
*/
  
</style>
<script>
var ws;
var wsm_max_len = 4096; /* bigger length causes uart0 buffer overflow with low speed smart device */
var timer_id;

function update_text(text) {
  var chat_messages = document.getElementById("Rxlog");
  chat_messages.innerHTML = text ;
  //chat_messages.innerHTML += text + '<br>';
  //chat_messages.scrollTop = chat_messages.scrollHeight;
}

function send_onclick() {
  if(ws != null) {
    var message = document.getElementById("message").value;
    
    if (message) {
      document.getElementById("message").value = "";
      ws.send(message + "\n");
      update_text('<span style="color:navy">' + message + '</span>');
      // You can send the message to the server or process it as needed
    }
  }
}

function connect_onclick() {
  if(ws == null) {
    ws = new WebSocket("ws://" + window.location.host + ":81");
    // Change binary type from "blob" to "arraybuffer"
	ws.binaryType = "arraybuffer";
    //ws = new WebSocket("ws://blue:8080");
    document.getElementById("ws_state").innerHTML = "CONNECTING";
    ws.onopen = ws_onopen;
    ws.onclose = ws_onclose;
    ws.onmessage = ws_onmessage;
  } else
    ws.close();
}

function ws_onopen() {
  document.getElementById("ws_state").innerHTML = "<span style='color:blue'> CONNECTED </span>";
  document.getElementById("bt_connect").innerHTML = "Disconnect";
  //document.getElementById("chat-messages").innerHTML = "";
  //ws.send("R \n");
  //update_text("Send: " + "R");
  document.getElementById("websocket").classList.add("hide_ws");
  //timer_id=setInterval(getDMX, 500);
  ws.send("w \n");//start auto refresh dmx
}

function getDMX()
{
	ws.send("W \n");
}

function closeWS()
{
	ws.send("m \n"); //stop auto refresh dmx
	ws.close();
    return true;
}


function ws_onclose() {
  document.getElementById("ws_state").innerHTML = "<span style='color:gray'> CLOSED </span>";
  document.getElementById("bt_connect").innerHTML = "Connect";
  ws.onopen = null;
  ws.onclose = null;
  ws.onmessage = null;
  ws = null;
  document.getElementById("websocket").classList.remove("hide_ws");
  //clearTimeout(timerId);
}

function ws_onmessage(e_msg) {
	if (e_msg.data instanceof ArrayBuffer) {
		// binary frame
		//logRX('got a BIN ArrayBuffer');
		const view = new DataView(e_msg.data);
		//console.log("got ArrayBuffer");
		
		switch(view.getUint8(0)) {
			case 0: //DMX frame
				for(let i = 1; i < view.byteLength; i++)
				{
					document.getElementById("dmx_val_" + i).innerHTML=view.getUint8(i);
					var colorslider = rainbow(2550, 1024 - (view.getUint8(i) * 4) );
					document.getElementById("dmx_val_" + i).style.color=colorslider;
				}
				break;
				
			default:
				// code block
		}
		
    }else if (e_msg.data instanceof Blob) {
		// binary frame
		//logRX('got a BIN Blob');
		const view = new DataView(e_msg.data);
		//console.log("got blob");
		//console.log(view.getUint8(0));
    }else{
		e_msg = e_msg || window.event; // MessageEvent
		//console.log(e_msg.data);
		logRX(e_msg.data);
		//update_text('<span style="color:blue">' + e_msg.data + '</span>');
	}

}

// http://youmightnotneedjquery.com/#trigger_custom
const triggerCustom = (el, eventName, data) => {
  let event;
  if (window.CustomEvent && typeof window.CustomEvent === 'function') {
    event = new CustomEvent(eventName, { detail: data });
  } else {
    event = document.createEvent('CustomEvent');
    event.initCustomEvent(eventName, true, true, data);
  }
  el.dispatchEvent(event);
};

// csv to array ***************
function CSVtoArray(text) {
	let ret = [''], i = 0, p = '', s = true;
	for (let l in text) {
		l = text[l];
		if ('"' === l) {
			s = !s;
			if ('"' === p) {
				ret[i] += '"';
				l = '-';
			} else if ('' === p)
				l = '-';
		} else if (s && ',' === l)
			l = ret[++i] = '';
		else
			ret[i] += l;
		p = l;
	}
	return ret;
}

// color fct ******************
function rainbow(numOfSteps, step) {
// This function generates vibrant, "evenly spaced" colours (i.e. no clustering). This is ideal for creating easily distinguishable vibrant markers in Google Maps and other apps.
// Adam Cole, 2011-Sept-14
// HSV to RBG adapted from: http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript
	var r, g, b;
	var h = step / numOfSteps;
	var i = ~~(h * 6);
	var f = h * 6 - i;
	var q = 1 - f;
	switch(i % 6){
		case 0: r = 1; g = f; b = 0; break;
		case 1: r = q; g = 1; b = 0; break;
		case 2: r = 0; g = 1; b = f; break;
		case 3: r = 0; g = q; b = 1; break;
		case 4: r = f; g = 0; b = 1; break;
		case 5: r = 1; g = 0; b = q; break;
	}
	var c = "#" + ("00" + (~ ~(r * 255)).toString(16)).slice(-2) + ("00" + (~ ~(g * 255)).toString(16)).slice(-2) + ("00" + (~ ~(b * 255)).toString(16)).slice(-2);
	return (c);

}

function isElementInViewport (el) {
	const box = el.getBoundingClientRect();
	return box.top < window.innerHeight && box.bottom >= 0;
}

function logRX(msg) {
	var parsedMsg = CSVtoArray(msg);
	const click_cells = document.getElementsByClassName("clickcell");
	if( String(parsedMsg[0]).indexOf("LORA") != -1 )
	{
		var lora_alive=CSVtoArray(parsedMsg[1]);
		for(let j = 0; j < click_cells.length; j++)
		{
			if(lora_alive[j] === "0"){
				click_cells[j].classList.remove('alive');
			}else{
				click_cells[j].classList.add('alive');
			}
		}
	}else{
		document.getElementById('Rxlog').textContent ="RX: " + msg;
	}
}

document.onreadystatechange = function ()
{
	if (document.readyState == "complete")
	{
		connect_onclick();
	}
}

</script>
</head>


<body>

<div class="chat-container">
	<pre id="Rxlog" class="ui-state-error" >INFO > not connected</pre>
	<div class="websocket" id="websocket">
		<button class="connect-button" id="bt_connect" onclick="connect_onclick()">Connect</button>
		<span class="label">State:<span id="ws_state"><span style="color:orange"> CLOSED </span></span></span>
	</div>
</div>
<div class="links">
	<a href="/dimmers.html" class="dmxlink" onClick="return closeWS()">DIM</a>
	<a href="/faders.html" class="dmxlink" onClick="return closeWS()">FAD</a>
	<a href="/scenes.html" class="dmxlink" onClick="return closeWS()">SCN</a>
	<a href="/fx1.html" class="dmxlink" onClick="return closeWS()">FX1</a>
	<a href="/fx2.html" class="dmxlink" onClick="return closeWS()">FX2</a>
	<a href="/vu.html" class="dmxlink" style="border-color: orange" onClick="return closeWS()">DMX</a>
	<a href="/settings.html" class="dmxlink" onClick="return closeWS()">SET</a>
</div>
<div class="dim">
	<H3>VU DMX</H3>
</div>
<div id="nav_cont" class="nav_cont">
	<div id="container" style="margin: auto;">
		<div class="onewfaders" id="table_settings">dmx,32,16</div>
	</div>
</div>

<script>
/* ANONyMOUS FCT **************************************************/
		
 
	// fct init ********************************************************
	const fct_butt = document.getElementsByClassName("class_fct_butt");
	const fct_butt_init = function () {
		// lets put your function to every one of them
		for(let i = 0; i < fct_butt.length; i++){
			fct_butt[i].addEventListener('click', function() {
				const fctid=fct_butt[i].getAttribute("name");
				location.replace("http://" + window.location.host + "" + fctid);
			});
		}
	};
	fct_butt_init();
	
	// table ***********************************************************
	const fct_table_init = function () 
	{  
		const d = document.getElementById("table_settings");
		var presets =  table_settings.textContent;
		var preset = CSVtoArray(presets);
		const tableName = preset[0];
		const rows = Number(preset[1]); 
		const cols = Number(preset[2]);
		
		var dmx_ch=0;
		let table = '<table>';  
		for (let i = 0; i< rows; i++) 
		{  
			table += '<tr>';  
			for (let j = 0; j < cols; j++) 
			{  
				dmx_ch += 1;
				table += "<td><div class=\"dmx_ch\" >" + dmx_ch + "</div><div class=\"dmx_val\" id=\"dmx_val_" + dmx_ch + "\" >" + dmx_ch +"</div></td>";  
			}  
			table += '</tr>';  
		}  
		table += '</table>';  
		d.outerHTML = table; 
	}
	fct_table_init();

</script>

</body>

</html>
